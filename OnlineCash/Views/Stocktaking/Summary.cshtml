@model OnlineCash.Models.StockTackingModels.StocktackingSummaryModel

<div class="row mt-4">
    <div class="col-12">
        <h4>Инверторизация @Model.Start.ToString("dd.MM.yy HH:mm")</h4>
        <h5 class="mb-1">Сумма товара в магазине до инверторизации @Model.SumDb</h5>
        <h5 class="mb-1">Сумма товара в магазине по инверторизации @Model.SumFact</h5>
        @if (Model.SumFact - Model.SumDb > 0)
        {
            <h5>Пересорт @(Model.SumFact - Model.SumDb) руб.</h5>
        }
        @if (Model.SumFact - Model.SumDb < 0)
        {
            <h5>Недостача @(Model.SumDb - Model.SumFact) руб.</h5>
        }
    </div>
</div>

<div class="row mt-1">
    <div class="col-lg-4">
        <input id="findGood" oninput="find()" class="form-control form-control-sm" placeholder="Поиск" />
    </div>
</div>

<div class="table-responsive mt-2">
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>Товар</th>
                <th>Ед</th>
                <th>Предыдущая инверт</th>
                <th>Факт остаток</th>
                <th>Расхождение</th>
                <th>Сумма расхождения</th>
            </tr>
        </thead>
        <tbody id="summaryTable">
            @foreach (var summary in Model.Goods)
            {
                string background = "";
                if (summary.CountFact - summary.CountDb > 0)
                    background = "bg-info";
                if (summary.CountFact - summary.CountDb < 0)
                    background = "bg-warning";
                <tr class="@background" onclick="openDocDetail(@summary.GoodId, '@summary.GoodName')">
                    <td goodName>@summary.GoodName</td>
                    <td>@summary.Unit.GetDescription()</td>
                    <td>@summary.CountLast</td>
                    <td>@summary.CountFact</td>
                    <td>@summary.CountEnd</td>
                    <td>@summary.SumEnd</td>
                </tr>
            }
        </tbody>
        <thead>
            <tr>
                <th colspan="5">Итого</th>
                <th>@(Model.SumDb - Model.SumFact)</th>
            </tr>
        </thead>
    </table>
</div>

<div class="modal fade" id="docDetailModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="docDetailGoodName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Документ</th>
                            <th>Номер</th>
                            <th>Кол-во</th>
                        </tr>
                    </thead>
                    <tbody id="docDetailList"></tbody>
                    <tbody>
                        <tr>
                            <th colspan="2"></th>
                            <th id="docDetailCountSummary"></th>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
<script>
    var idAct =@Model.Id ;

    const findGood = document.getElementById("findGood");
    const summaryTable = document.getElementById("summaryTable");
    const docDetailModal = new bootstrap.Modal(document.getElementById('docDetailModal'), {});
    const docDetailGoodName = document.getElementById("docDetailGoodName");
    const docDetailList = document.getElementById("docDetailList");
    const docDetailCountSummary = document.getElementById("docDetailCountSummary");

    function find() {
        let str = findGood.value.toLowerCase();
        summaryTable.querySelectorAll("tr").forEach(tr => {
            let name = tr.querySelector("td[goodName]").textContent;
            if (name.toLowerCase().indexOf(str) != -1)
                tr.style.display = "table-row";
            else
                tr.style.display = "none";
        })
    }

    function openDocDetail(goodId, goodName) {
        docDetailGoodName.textContent = goodName;
        docDetailList.querySelectorAll("tr").forEach(tr => tr.remove());
        fetch(`/Stocktaking/GetDetailGoodCountByDocs?stocktakingId=${idAct}&goodId=${goodId}`)
            .then(r => r.json())
            .then(docs => docs.forEach(doc => {
                if (doc.type != "Итог") {
                    let tr = document.createElement("tr");
                    tr.innerHTML = `<td>${doc.type}</td><td>${doc.num}</td><td>${doc.count}</td>`;
                    docDetailList.append(tr);
                }
                else
                    docDetailCountSummary.textContent = doc.count;
            }));

        docDetailModal.show();
    }
</script>